import { useState, useEffect, useRef } from 'react';
import { supabase } from '../lib/supabase';
import { Send, Flame, Skull, Ghost } from 'lucide-react';

interface Message {
    id: number;
    content: string;
    username: string;
    avatar_color: string;
    user_id: string;
    created_at: string;
    aura: number;
    flags: number;
    reactions: Record<string, string[]>;
}

interface ChatInterfaceProps {
    college: string;
    currentUserId: string;
}

const REACTION_EMOJIS = {
    flame: 'ðŸ”¥',
    skull: 'ðŸ’€',
    clown: 'ðŸ¤¡',
    ghost: 'ðŸ‘»'
} as const;

type ReactionType = keyof typeof REACTION_EMOJIS;

export function ChatInterface({ college, currentUserId }: ChatInterfaceProps) {
    const [messages, setMessages] = useState<Message[]>([]);
    const [newMessage, setNewMessage] = useState('');
    const [loading, setLoading] = useState(false);
    const messagesEndRef = useRef<HTMLDivElement>(null);
    const messagesContainerRef = useRef<HTMLDivElement>(null);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        fetchMessages();

        const channel = supabase
            .channel('messages')
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'messages', filter: `college=eq.${college}` },
                () => {
                    fetchMessages();
                }
            )
            .subscribe();

        return () => {
            supabase.removeChannel(channel);
        };
    }, [college]);

    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    const fetchMessages = async () => {
        const { data, error } = await supabase
            .from('messages')
            .select('*')
            .eq('college', college)
            .order('created_at', { ascending: true })
            .limit(100);

        if (!error && data) {
            setMessages(data);
        }
    };

    const handleSendMessage = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!newMessage.trim()) return;

        setLoading(true);

        const identityStr = localStorage.getItem('universe_identity');
        if (!identityStr) {
            alert('Please refresh the page to regenerate your identity.');
            setLoading(false);
            return;
        }

        const identity = JSON.parse(identityStr);

        const { error } = await supabase.from('messages').insert({
            content: newMessage.trim(),
            college,
            user_id: currentUserId,
            username: identity.username,
            avatar_color: identity.color,
            aura: 0,
            flags: 0,
            reactions: {}
        });

        if (error) {
            alert('Failed to send message. Please try again.');
        } else {
            setNewMessage('');
        }

        setLoading(false);
    };

    const handleReaction = async (messageId: number, reactionType: ReactionType) => {
        const message = messages.find(m => m.id === messageId);
        if (!message) return;

        const reactions = message.reactions || {};
        let updatedReactions = { ...reactions };

        const hasReacted = reactions[reactionType]?.includes(currentUserId);

        if (hasReacted) {
            updatedReactions[reactionType] = reactions[reactionType].filter(id => id !== currentUserId);
            if (updatedReactions[reactionType].length === 0) {
                delete updatedReactions[reactionType];
            }
        } else {
            Object.keys(updatedReactions).forEach(key => {
                updatedReactions[key] = updatedReactions[key].filter(id => id !== currentUserId);
                if (updatedReactions[key].length === 0) {
                    delete updatedReactions[key];
                }
            });

            if (!updatedReactions[reactionType]) {
                updatedReactions[reactionType] = [];
            }
            updatedReactions[reactionType].push(currentUserId);
        }

        const { error } = await supabase
            .from('messages')
            .update({ reactions: updatedReactions })
            .eq('id', messageId);

        if (!error) {
            setMessages(prev =>
                prev.map(m => m.id === messageId ? { ...m, reactions: updatedReactions } : m)
            );
        }
    };

    const getUserReaction = (message: Message): ReactionType | null => {
        const reactions = message.reactions || {};
        for (const [type, users] of Object.entries(reactions)) {
            if (users.includes(currentUserId)) {
                return type as ReactionType;
            }
        }
        return null;
    };

    return (
        <div className="flex flex-col h-full bg-slate-950/40 rounded-2xl backdrop-blur-sm border border-white/5">
            <div
                ref={messagesContainerRef}
                className="flex-1 overflow-y-auto p-4 space-y-3"
            >
                {messages.map((message) => {
                    const isOwnMessage = message.user_id === currentUserId;
                    const userReaction = getUserReaction(message);
                    const reactions = message.reactions || {};
                    const hasReactions = Object.keys(reactions).length > 0;

                    return (
                        <div
                            key={message.id}
                            className={`flex ${isOwnMessage ? 'justify-end' : 'justify-start'} animate-fadeIn`}
                        >
                            <div className={`max-w-[70%] ${isOwnMessage ? 'items-end' : 'items-start'} flex flex-col`}>
                                {!isOwnMessage && (
                                    <div className="flex items-center space-x-2 mb-1 ml-2">
                                        <div
                                            className="w-2 h-2 rounded-full"
                                            style={{ backgroundColor: message.avatar_color }}
                                        />
                                        <span
                                            className="text-xs font-medium"
                                            style={{ color: message.avatar_color }}
                                        >
                                            {message.username}
                                        </span>
                                    </div>
                                )}

                                <div
                                    className={`relative px-4 py-2 rounded-2xl ${isOwnMessage
                                            ? 'bg-gradient-to-r from-primary to-secondary text-white rounded-br-sm'
                                            : 'glass-card text-gray-100 rounded-bl-sm'
                                        } shadow-lg`}
                                >
                                    <p className="text-sm break-words">{message.content}</p>

                                    <span className="text-[10px] opacity-60 mt-1 block">
                                        {new Date(message.created_at).toLocaleTimeString('en-US', {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </span>
                                </div>

                                {hasReactions && (
                                    <div className="flex space-x-1 mt-1 ml-2">
                                        {Object.entries(reactions).map(([type, users]) => {
                                            if (users.length === 0) return null;
                                            return (
                                                <div
                                                    key={type}
                                                    className="flex items-center space-x-1 bg-slate-800/80 rounded-full px-2 py-0.5 border border-white/10"
                                                >
                                                    <span className="text-xs">{REACTION_EMOJIS[type as ReactionType]}</span>
                                                    <span className="text-[10px] text-gray-400">{users.length}</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                <div className="flex space-x-1 mt-2">
                                    {(Object.keys(REACTION_EMOJIS) as ReactionType[]).map((type) => (
                                        <button
                                            key={type}
                                            onClick={() => handleReaction(message.id, type)}
                                            className={`p-1.5 rounded-full transition-all hover:scale-110 ${userReaction === type
                                                    ? 'bg-primary/30 ring-2 ring-primary/50'
                                                    : 'bg-slate-800/40 hover:bg-slate-700/60'
                                                }`}
                                            title={type}
                                        >
                                            <span className="text-sm">{REACTION_EMOJIS[type]}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    );
                })}
                <div ref={messagesEndRef} />
            </div>

            <div className="border-t border-white/10 p-4 bg-slate-900/60 backdrop-blur-sm rounded-b-2xl">
                <form onSubmit={handleSendMessage} className="flex space-x-2">
                    <input
                        type="text"
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        placeholder="Type a message..."
                        className="flex-1 glass-input text-white rounded-xl py-3 px-4 focus:outline-none focus:ring-2 focus:ring-primary/50 placeholder-gray-500 transition-all"
                        disabled={loading}
                    />
                    <button
                        type="submit"
                        disabled={loading || !newMessage.trim()}
                        className="bg-gradient-to-r from-primary to-secondary text-white p-3 rounded-xl hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-primary/25"
                    >
                        <Send className="w-5 h-5" />
                    </button>
                </form>
            </div>
        </div>
    );
}
